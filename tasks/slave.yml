---
# Tasks for Slave nodes

- name: create working dir
  file:
    path: "{{ mesos_slave_work_dir }}"
    state: directory
    mode: 0755


- block:
    - set_fact:
        mesos_isolation: []
    - shell: /usr/bin/nvidia-smi
      register: nvidia_cmd_result
      when: (mesos_enable_gpu_support == true)
      changed_when: False
      failed_when: False
    - set_fact:
        mesos_isolation: "{{mesos_isolation}} + ['docker/runtime','filesystem/linux','cgroups/devices','gpu/nvidia']"
      when: (mesos_enable_gpu_support == true) and (nvidia_cmd_result.rc==0)

- name: Mesos default config file
  template: src=mesos-slave-env.j2 dest=/etc/mesos/mesos-agent
  notify:
    - Restart mesos-slave

- block:
    - name: install Debian OS dependencies
      apt: pkg="{{ mesos_package_dependencies }}" state=present update_cache=yes cache_valid_time=3600
    - name: install mesos package
      apt:
        deb: "{{ mesos_deb_package_url }}"    
    - name: Enable and start agent service
      service:
        enabled: true
        name: mesos-agent
        state: started        
  when: mesos_agent_install_mode == "package" and ansible_distribution == 'Ubuntu'


